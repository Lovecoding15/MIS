0010 REM <ec_credit.bbx>
0020 SETESC CLOSE_EXIT
0030 SETERR CLOSE_EXIT
0040 ENTER FIRM$,CUST$,AVAILABLE_CREDIT
0050 LET AVAILABLE_CREDIT=0
0060 LET FILES=3,C=1; DIM CHAN[FILES]
0070 CALL "ec_open::SYS01C"; LET CHAN[C]=SYS01C,C=C+1
0080 CALL "ec_open::ARM02"; LET CHAN[C]=ARM02,C=C+1
0090 CALL "ec_open::ARE03"; LET CHAN[C]=ARE03,C=C+1
0100 READ RECORD(SYS01C,KEY=FIRM$+"AR01")SYS01C$
0110 LET AVAILABLE_CREDIT=NUM(SYS01C.HOLD_AMOUNT$)
0120 LET T1=0,T9=0
0130 READ RECORD(ARM02,KEY=FIRM$+CUST$+"  ")ARM02$
0140 ARE03_READ: 
0150 READ RECORD(ARE03,KEY=FIRM$+"  "+CUSTOMER$,DOM=NEXT_ARE03)
0160 NEXT_ARE03: 
0170 LET K$=KEY(ARE03,END=CREDIT_CALC)
0180 IF K$(1,10)<>FIRM$+"  "+CUST$ THEN GOTO CREDIT_CALC
0190 READ RECORD(ARE03)ARE03$
0200 IF POS(ARE03.INVOICE_TYPE$="PV")=0 THEN LET T1=T1+ARE03.TOTAL_SALES
0210 GOTO NEXT_ARE03
0220 CREDIT_CALC: 
0230 LET T9=ARM02.AGING_FUTURE+ARM02.AGING_CUR+ARM02.AGING_30+ARM02.AGING_60+ARM02.AGING_90+ARM02.AGING_120
0240 IF ARM02.CREDIT_LIMIT THEN LET AVAILABLE_CREDIT=ARM02.CREDIT_LIMIT-T9-T1
0250 CLOSE_EXIT: 
0260 IF FILES=0 THEN GOTO PGM_EXIT
0270 FOR I=1 TO FILES
0280 CLOSE (CHAN[I],ERR=NEXTI)
0290 NEXTI: NEXT I
0300 PGM_EXIT: EXIT 
