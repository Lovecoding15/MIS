0010 REM "TMX - Convert Data from Database to TMM-01
0020 REM "Program TMX.BA
0030 REM "12/10/91 By Jerry Koch for MAS
0031 REM "05/04/92 By MAP for MAS-Redmond
0040 ESCAPE
0050 BEGIN 
0090 SETERR 9000
0120 OPEN (2)"TMM-02"
0180 REM  OPEN (8,OPT="TEXT") "fileitf"
0480 LET PHONE=2060000000,RECORDS=0
0500 REM "--- Clear Masterfile
0520 ERASE "TMM-01",ERR=0521
0550 REM  MSORT "TMM-01",[1:1:22],[1:1:2]+[1:23:15]+[1:1:22],[1:1:2]+[1:285:11]+[1:1:22],[1:1:2]+[1:285:3]+[2:1:20]+[1:1:22],[1:1:2]+[1:38:10]:"U",0,900,0,0
0580 OPEN (1)"TMM-01"
1100 REM "--- Main Read
1110 READ (8,END=9900)X0$
1120 LET X$=X0$
1200 REM "--- Setup
1210 DIM A0$(450),A1$(260),A2$(0),A3$(1),A4$(10)
1220 DIM F$[39]
1230 FOR I=1 TO 39
1240 LET X=POS("~"=X$)
1250 LET F$[I]=X$(1,X-1),X$=X$(X+1)
1290 NEXT I
1500 REM "--- Strip dashes from phone
1505 LET F$[9]=F$[8]+F$[9]
1510 LET X=POS("9"<F$[9]); IF X=0 THEN LET X=POS("0">F$[9])
1520 IF X=0 THEN GOTO 1550
1530 LET F$[9]=F$[9](1,X-1)+F$[9](X+1)
1540 GOTO 1510
1550 IF F$[9]="" THEN LET F$[9]=STR(PHONE:"0000000000"),PHONE=PHONE+1
1600 REM "--- Strip Mr/Mrs/Ms out of name
1605 LET DEAR$="",DEAR$=F$[20]
1610 IF POS("MR"=F$[19])=1 OR POS("MS"=F$[19])=1 THEN GOTO 1621
1620 GOTO 1700
1630 LET X=POS(" "=F$[19]); IF X=0 THEN GOTO 1700
1640 LET DEAR$=F$[19](1,X)
1650 LET F$[19]=F$[19](X+1)
2000 REM "--- Load Data
2010 LET A0$(1)="01"
2020 LET A0$(3,20)=F$[3]
2025 IF POS(" "<>A0$(3,20))=0 THEN LET A0$(3,20)=F$[3]
2030 LET A0$(23,15)=F$[30]
2040 LET A0$(38,10)=F$[9]
2050 LET A0$(52,30)=F$[19]
2060 LET A0$(82,30)=F$[21]
2070 LET A0$(112,30)=F$[3]
2075 LET A0$(142,30)=F$[4]
2080 LET A0$(202,25)=F$[5]
2090 LET A0$(227,2)=F$[6]
2100 LET A0$(229,9)=F$[7]
2110 LET A0$(285,3)=F$[36]
2120 LET A0$(288,8)=FND$(F$[38])
2130 LET A0$(339,8)=FND$(F$[39])
2140 LET A0$(347,5)="BML"
2150 LET A0$(369,10)=DEAR$
2200 REM "--- User Definable
2210 LET A1$(1,20)=F$[17]
2220 LET A1$(21,20)=F$[32]
2230 LET A1$(41,20)=F$[33]
2240 LET A1$(61,20)=F$[12]
2250 LET A1$(81,20)=F$[13]
2260 LET A1$(101,20)=F$[30]
2270 REM "LET A1$(121,20)=F$[19]
2280 REM "LET A1$(141,20)=F$[15]
2290 REM "LET A1$(161,20)=F$[16]
2500 REM "LET A3$(1)=F$[22]
2510 REM "LET A4$(1)=STR(NUM(F$[18],ERR=02511))
2900 REM "--- Write Master Record
2910 PRINT @(10,10),F$[1],
2920 IF POS(" "<>A0$(3,20))=0 THEN GOTO 1100
2930 WRITE (1,KEY=A0$(1,22),DOM=1100)A0$,A1$,A2$,A3$,A4$
2940 LET RECORDS=RECORDS+1
3000 REM "--- Write Comment Records
3010 DIM B1$(80)
3020 LET B0$=A0$(1,22)+STR(99999999-19991231)+"001"
3030 LET B1$(1)=F$[22]
3045 IF POS(" "<>B1$)=0 THEN GOTO 3051
3050 WRITE (2,KEY=B0$)B0$,B1$
3060 LET B0$(31,3)="002",B1$(1)=F$[23]
3070 IF POS(" "<>B1$)=0 THEN GOTO 3081
3080 WRITE (2,KEY=B0$)B0$,B1$
3090 GOTO 1100
8010 DEF FND$(Q$)="19"+Q$(7,2)+Q$(1,2)+Q$(4,2)
9000 REM " --- Input/Maintenance Error Processing"
9010 LET E$=LST(PGM(TCB(5))),E1$=STR(TCB(5)),E2$=PGM(-2),E0=ERR,E1=0
9030 CALL "SYC.EA",ERR=9080,E$,E1$,E2$,E0,E1
9040 IF E1=1 THEN GOTO 9100
9060 IF E1=3 THEN GOTO 9200
9080 PRINT @(0,22),'CL',E$,'LF','LF',
9090 ESCAPE
9100 REM " --- Retry"
9110 SETERR 9000
9120 RETRY
9200 REM "F4/END OPTION FOR LOCKED RECORD
9210 SETERR 9000
9220 GOTO 0900
9900 REM "DONE
9910 PRINT RECORDS," Records Written"
9920 INPUT *
9950 RUN "SYS.AA"
9999 END
