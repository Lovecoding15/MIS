0001 SETERR 0060; SETESC 0740
0010 REM Pipe to key generator  <SYGENKEY>
0030 REM Oct. 1995--Turn network flag off on multi_user 10665
0050 ENTER TYPE$,SERIAL_NUM$,NUMBER_USERS,PORT_ID$,REVISION$,KEYPATH$,KEY$
0052 REM -KEYPATH$ no longer used, use STBLs instead- th 2/15/01
0060 SETERR 0740
0070 LET TYPE$=CVS(TYPE$,3),SERIAL_NUM$=CVS(SERIAL_NUM$,3)
0190 LET TYPES_FILE_NAME$=STBL("DATA_SERVER")+STBL("AON")+"ADATA/BBXTYPES"
0210 LET TEMP_FILE_NAME$=STBL("AON")+"tmp/KEY"+FID(0)
0230 LET KEY_PROGRAM$=STBL("AON")+"bas/key"
0240 IF PORT_ID$(1,3)="146" AND NUMBER_USERS=1 THEN LET NUMBER_USERS=0
0270 REM read types file
0280 LET TYPES=UNT
0290 OPEN (TYPES)TYPES_FILE_NAME$
0300 READ (TYPES,ERR=330)A$
0310 IF POS(TYPE$=A$)=1 THEN GOTO 0360
0320 GOTO 0300
0330 CLOSE (TYPES)
0340 LET KEY$="ERROR Invalid product type"
0350 GOTO EXIT_900
0360 REM type found
0370 CLOSE (TYPES)
0380 IF POS($09$=A$)=0 THEN LET KEY$="ERROR Invalid types file entry"; GOTO EX
0380:IT_900
0390 LET A$=A$(POS($09$=A$)+1)
0400 REM xlate commas to newlines
0410 LET A$=TBL(A$,TBL=0730)
0415 IF POS("SQL"=TYPE$)=1 THEN LET PORT_ID$(1,1)="2"
0420 REM write temp file with key generating commands
0430 ERASE TEMP_FILE_NAME$,ERR=440
0440 STRING TEMP_FILE_NAME$
0450 LET TEMP=UNT
0460 OPEN (TEMP)TEMP_FILE_NAME$
0480 PRINT (TEMP)"serial "+SERIAL_NUM$
0490 PRINT (TEMP)"portid "+PORT_ID$
0500 PRINT (TEMP)"rev "+REVISION$
0510 PRINT (TEMP)"users ",NUMBER_USERS
0520 REM Turn off network switch on multi-user 10665
0530 IF PORT_ID$="10665" AND NUMBER_USERS>1 THEN PRINT (TEMP)"network 0"
0540 PRINT (TEMP)A$
0550 PRINT (TEMP)"key"
0560 CLOSE (TEMP)
0570 REM establish pipe
0580 LET PIPE=UNT
0590 OPEN (PIPE)"<"+KEY_PROGRAM$+"<"+TEMP_FILE_NAME$
0600 READ (PIPE,ERR=620)A$
0610 GOTO 0600
0620 CLOSE (PIPE)
0630 LET KEY$=A$
0640 ERASE TEMP_FILE_NAME$,ERR=650
0650 REM 
0720 GOTO EXIT_900
0730 TABLE FF 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 10 11 12 13 14 15 16 17 18 19 1A 1B 1C 1D 1E 1F 20 21 22 23 24 25 26 27 28 29 2A 2B 0A
0740 LET KEY$="ERROR "+STR(ERR)+" in "+STR(TCB(5))
0810 GOTO EXIT_900
0900 REM 900
0910 EXIT_900: 
0930 EXIT
