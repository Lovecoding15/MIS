0001 REM <BSN.01> 
0010 REM IF INFO(3,2)="thines" THEN ESCAPE
0020 REM Generate new serial number, check for duplicates
0030 SETERR EXIT
0040 REM SERIALNUM$ - Serial number generated by CSE.DH - Use prefix only
0050 ENTER SERIALNUM$,ARM02CHAN,FIRM$,CUST$
0060 DIM NEWSN$:"SERIAL_PFX:C(3),AVAILABLE:C(7),SERIAL_CNTR:N(6)"
0070 LET NEWSNCHAN=UNT; OPEN (NEWSNCHAN)"SERIALNUMBERS"
0080 LET ARE83CHAN=UNT; OPEN (ARE83CHAN)"ARE-83"
0090 LET SNM01CHAN=UNT; OPEN (SNM01CHAN)"SNM-01"
0100 LET MSG$="Serial number prefix not found",SN_PRFX$=SERIALNUM$(1,3)
0110 READ (ARM02CHAN,KEY=FIRM$+CUST$+"  ")*,PFX$
0120 IF CVS(PFX$(46,3),2)<>"" THEN LET SN_PRFX$=PFX$(46,3)
0200 EXTRACT_SERIALNUMBER: 
0210 EXTRACT (NEWSNCHAN,KEY=SN_PRFX$,ERR=ERRMSG)NEWSN$
0220 LET SERIALNUM$=NEWSN.SERIAL_PFX$+STR(NEWSN.SERIAL_CNTR:"000000")
0230 IF NEWSN.SERIAL_PFX$="TAO" THEN LET SERIALNUM$=SERIALNUM$(4); REM No prefix for Taos SN
0240 LET NEWSN.SERIAL_CNTR=NEWSN.SERIAL_CNTR+1
0250 WRITE (NEWSNCHAN,KEY=SN_PRFX$,ERR=ERRMSG)NEWSN$
0260 DUP_CHECK: 
0270 LET MSG$="Duplicate serial number"
0280 READ (ARE83CHAN,KEY="",DOM=ARE83)
0290 ARE83: READ (ARE83CHAN,END=ARE83END)*,*,S$
0300 IF POS(SERIALNUM$=S$)=1 THEN GOTO ERRMSG ELSE GOTO ARE83
0310 ARE83END: 
0320 LET K$=SERIALNUM$+FILL(20-LEN(SERIALNUM$))
0330 READ (SNM01CHAN,KEY=K$,DOM=EXIT)
0340 ERRMSG: 
0350 PRINT 'WINDOW'(10,10,50,7,"")
0360 PRINT 'CS',@(2,1),SERIALNUM$
0370 PRINT @(2,2),MSG$
0380 INPUT @(2,3),"Delete this line and call MIS ",X$
0390 PRINT 'POP'
0400 EXIT: 
0410 SETERR EXIT2
0420 CLOSE (ARE83CHAN)
0430 CLOSE (SNM01CHAN)
0440 CLOSE (NEWSNCHAN)
0450 EXIT2: 
0460 EXIT
